<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>
        Nefelibata
    </title>
    
<link rel="stylesheet" href="/blog/css/style.css">

    <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.png" />
    <link rel="stylesheet" href="../css/style/github.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
    <script src="../js/jquery.min.js"></script>
    <script src="../js/highlight.min.js"></script>
    <!-- Include jQuery -->
    <!-- <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script> -->
    <!-- Include ClipboardJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.8/clipboard.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
<meta name="generator" content="Hexo 6.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/blog/atom.xml" title="Nefelibata" type="application/atom+xml">
</head>

<body>
    <div class="container">
        <div class="header">
    <!-- <div class="logo">
        <a href="/blog/">Nefelibata</a>
    </div> -->
    <!-- <div class="logo">
        <img src="/images/lkp.png" alt="Logo">
    </div> -->
    <div class="nav">
        <ul class="menu">
            
                <li class="menu-item">
                    <a href="/blog/../" class="menu-item-link">
                        Nefelibata
                    </a>
                </li>
            
                <li class="menu-item">
                    <a href="/blog/" class="menu-item-link">
                        Blog
                    </a>
                </li>
            
                <li class="menu-item">
                    <a href="/blog/../gallery" class="menu-item-link">
                        Gallery
                    </a>
                </li>
            
                <li class="menu-item">
                    <a target="_blank" rel="noopener" href="https://github.com/kpl0111" class="menu-item-link">
                        Github
                    </a>
                </li>
            
                <li class="menu-item">
                    <a href="/blog/../about" class="menu-item-link">
                        About
                    </a>
                </li>
                
        </ul>
    </div>
</div>
        <div class="article">
    <!-- <div class="article-title">
        <h2>
            利用RSA加密算法和MD5哈希算法实现加密通信（C++）
        </h2>
    </div> -->
    
        
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"] ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/mathjax@2.7.8/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    
    <div class="article-meta">
        <div class="article-date">
            <i class="fas fa-edit"></i>
            2022/05/31 周二 17:40&nbsp;&nbsp;&nbsp;
            <span class="just-a-temp"><span>
            <i class="fas fa-redo"></i>
            2022/06/02 周四 22:56
        </div>
    </div>
    <div class="article-content">
        <blockquote>
<p>本篇为作者个人作业，仅供参考，转载请注明出处</p>
</blockquote>
<!-- toc -->
<h2 id="实验目的"><a class="markdownIt-Anchor" href="#实验目的"></a> 实验目的</h2>
<p>在保密通信过程中，对消息完整性的检验和对消息来源的认证，是一个非常重要的问题，本次大作业的内容为：</p>
<p>设计一个协议，利用rsa公钥加密算法和MD5哈希算法，实现对消息的完整性检验和发送者身份验证的功能，并编程实现这个协议。程序的要求是假设通讯双方为A和B，并假设发方拥有自己的RSA公钥PKA和私钥SKA ，同时收方B已经通过某种方式知道了发方的公钥PKA  。协议要求对发方A发来的消息，收方B通过检验，能够确定：</p>
<ol>
<li>B收到的消息是完整的，即消息在传送过程中没有遭到非法修改；</li>
<li>B收到的消息来源是真实的，即该消息的确是由A发来的，而不是由其他人伪造的。</li>
</ol>
<h2 id="实验要求"><a class="markdownIt-Anchor" href="#实验要求"></a> 实验要求</h2>
<ol>
<li>分别编写两个程序，一个为发方程序，一个为收方程序，写清楚两个程序分别要完成的功能，并能够在两个程序间进行通讯。</li>
<li>大作业的提交方式同实验报告的提交，也就是说既要提交程序实现的说明文档，也要提交源代码和可执行程序。</li>
</ol>
<h2 id="设计思路"><a class="markdownIt-Anchor" href="#设计思路"></a> 设计思路</h2>
<p>RSA公钥加密算法可以实现对消息的加密和解密，而MD5仅可对消息进行加密处理，且在之前的实验中经过测试均满足雪崩效应，因此初步思路是：</p>
<ol>
<li>利用MD5算法实现对发送方和接收方的身份确认
<ul>
<li>双方均知道对方身份，因此可以发送方对自己的ID使用MD5算法进行加密，并把加密后的密文ID发送给接收方</li>
<li>接收方接收到发送方的密文ID之后，利用自己已知的发送方ID（ID双方均已知，攻击者未知）同样对发送方原始ID进行MD5加密，并与发送方发送的密文ID进行比较，
<ul>
<li>如果一致，由于MD5算法具有雪崩效应，因此可认为发送方即为本人</li>
<li>如果不一致，则立即中止对话，保证信息的安全性</li>
</ul>
</li>
<li>身份确认之后即可进行消息发送接收</li>
</ul>
</li>
<li>身份确认之后利用RSA公钥体系对双方发送消息进行加密和解密
<ul>
<li>双方输入消息，利用RSA对消息进行加密，并把加密后消息使用TCP协议进行发送，这样即便消息被截获没有密钥也无法破译</li>
<li>接收方接收到密文后，利用密钥对其进行解密即可获取消息内容，同样也可发送消息<br>
利用TCP协议进行消息的收发，这里仅用来实现发送消息，TCP协议的安全性暂不考虑</li>
</ul>
</li>
</ol>
<h2 id="实验设计流程图"><a class="markdownIt-Anchor" href="#实验设计流程图"></a> 实验设计流程图</h2>
<p>实验流程图如下：<br>
<img src="https://s2.loli.net/2022/06/02/HJvAI4Raqdk1nxi.png" alt="1654167804"></p>
<p>RSA算法流程图如下：</p>
<p><img src="https://s2.loli.net/2022/06/02/oHS6y7IKfLsnj2D.png" alt="20220602191118"></p>
<p>MD5算法流程图如下：</p>
<p><img src="https://s2.loli.net/2022/05/23/Uj4DuPtrp7wq82v.png" alt="result4"></p>
<h2 id="md5算法实现身份验证"><a class="markdownIt-Anchor" href="#md5算法实现身份验证"></a> MD5算法实现身份验证</h2>
<ol>
<li>
<p>获取输入，该模块用于获取一段明文字符，不定长</p>
</li>
<li>
<p>对获取的不定长字符串进行填充,使其字节长度满足n*512 + 448, 填充规则是第一位填充1，后续填充0，直至满足上述条件，最后再用一个64为二进制字符串表示明文长度，这样填充之后长度为(n + 1)*512</p>
<pre class="highlight"><code class="C++"><span class="hljs-comment">// 填充字符串</span>
<span class="hljs-function">vector&lt;<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>&gt; <span class="hljs-title">padding</span><span class="hljs-params">(string src)</span> </span>{
    <span class="hljs-comment">// 以512位,64个字节为一组</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> num = ((src.<span class="hljs-built_in">length</span>() + <span class="hljs-number">8</span>) / <span class="hljs-number">64</span>) + <span class="hljs-number">1</span>;
    <span class="hljs-function">vector&lt;<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>&gt; <span class="hljs-title">rec</span><span class="hljs-params">(num*<span class="hljs-number">16</span>)</span></span>;
    strlength = num*<span class="hljs-number">16</span>;
    <span class="hljs-keyword">for</span>(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; src.<span class="hljs-built_in">length</span>(); i++){
        <span class="hljs-comment">// 一个unsigned int对应4个字节，保存4个字符信息</span>
        rec[i&gt;&gt;<span class="hljs-number">2</span>] |= (<span class="hljs-type">int</span>)(src[i]) &lt;&lt; ((i % <span class="hljs-number">4</span>) * <span class="hljs-number">8</span>);
    }
    <span class="hljs-comment">// 补充1000...000</span>
    rec[src.<span class="hljs-built_in">length</span>() &gt;&gt; <span class="hljs-number">2</span>] |= (<span class="hljs-number">0x80</span> &lt;&lt; ((src.<span class="hljs-built_in">length</span>() % <span class="hljs-number">4</span>)*<span class="hljs-number">8</span>));
    <span class="hljs-comment">// 填充原文长度</span>
    rec[rec.<span class="hljs-built_in">size</span>()<span class="hljs-number">-2</span>] = (src.<span class="hljs-built_in">length</span>() &lt;&lt; <span class="hljs-number">3</span>);
    <span class="hljs-keyword">return</span> rec;
}
</code></pre>
</li>
<li>
<p>字符串分块函数，将上述填充之后的字符串分割为L个512字节长度的字符串</p>
</li>
<li>
<p>循环压缩函数：对每个512-bit分组进行64轮迭代运算</p>
<ol>
<li>
<p>对分组（A, B, C, D）中的A进行迭代运算<br>
公式为：A &lt;= B + ((A + f(B,C,D) + X[k] + T[i])) &lt;&lt; S[i]<br>
其中：</p>
<ul>
<li>A,B,C,D代表MD5缓冲区当前的数值</li>
<li>f为轮函数，1-16轮迭代使用F函数，17-32轮迭代使用G函数，33-48轮迭 代使用H函数，49-64轮迭代使用I函数</li>
</ul>
<pre class="highlight"><code class="C++"><span class="hljs-comment">// F函数</span>
<span class="hljs-function"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title">F</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> b, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> c, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> d)</span> </span>{
    <span class="hljs-keyword">return</span> (b &amp; c) | ((~b) &amp; d);
}
<span class="hljs-comment">// G函数</span>
<span class="hljs-function"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title">G</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> b, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> c, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> d)</span> </span>{
    <span class="hljs-keyword">return</span> (b &amp; d) | (c &amp; (~d));
}
<span class="hljs-comment">// H函数</span>
<span class="hljs-function"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title">H</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> b, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> c, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> d)</span> </span>{
    <span class="hljs-keyword">return</span> b ^ c ^ d;
}
<span class="hljs-comment">// I函数</span>
<span class="hljs-function"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title">I</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> b, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> c, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> d)</span> </span>{
    <span class="hljs-keyword">return</span> c ^ (b | (~d));
}
<span class="hljs-comment">// 移位操作函数</span>
<span class="hljs-function"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title">shift</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> a, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> n)</span> </span>{
    <span class="hljs-keyword">return</span> (a &lt;&lt; n) | (a &gt;&gt; (<span class="hljs-number">32</span> - n));
}
</code></pre>
<ul>
<li>X[k]代表当前处理消息分组的第k个32位字，X[k]由第n轮迭代对应的顺序表决定</li>
<li>T[i]代表T表的第i项的值，T[i] = int(2^32 * |sin(i)|)</li>
<li>S[i]对应第i轮的左循环移位的s值</li>
</ul>
</li>
<li>
<p>对分组（A,B,C,D）作循环轮换<br>
公式为：（B,C,D,A）&lt;=（A,B,C,D）</p>
</li>
<li>
<p>按照1， 2步骤进行四轮循环压缩</p>
</li>
</ol>
<pre class="highlight"><code class="C++">    <span class="hljs-comment">// 循环压缩</span>
 <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">iterateFunc</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>* X, <span class="hljs-type">int</span> size = <span class="hljs-number">16</span>)</span> </span>{
     <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> a = tempA,
                  b = tempB,
                  c = tempC,
                  d = tempD,
                  rec = <span class="hljs-number">0</span>,
                  g, k;
     <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">64</span>; i++) {
         <span class="hljs-keyword">if</span>(i &lt; <span class="hljs-number">16</span>) {
             <span class="hljs-comment">// F迭代</span>
             g = <span class="hljs-built_in">F</span>(b, c, d);
             k = i;
         }
         <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(i &lt; <span class="hljs-number">32</span>) {
             <span class="hljs-comment">// G迭代</span>
             g = <span class="hljs-built_in">G</span>(b, c, d);
             k = (<span class="hljs-number">1</span> + <span class="hljs-number">5</span>*i) % <span class="hljs-number">16</span>;
         }
         <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(i &lt; <span class="hljs-number">48</span>) {
             <span class="hljs-comment">// H迭代</span>
             g = <span class="hljs-built_in">H</span>(b, c, d);
             k = (<span class="hljs-number">5</span> + <span class="hljs-number">3</span>*i) % <span class="hljs-number">16</span>;
         }
         <span class="hljs-keyword">else</span> {
             <span class="hljs-comment">// I迭代</span>
             g = <span class="hljs-built_in">I</span>(b, c, d);
             k = (<span class="hljs-number">7</span>*i) % <span class="hljs-number">16</span>;
         }
         rec = d;
         d = c;
         c = b;
         b = b + <span class="hljs-built_in">shift</span>(a + g + X[k] + T[i], s[i]);
         a = rec;
     }
     tempA += a;
     tempB += b;
     tempC += c;
     tempD += d;
 }
</code></pre>
</li>
<li>
<p>MD5编码主函数：用于调用前面的功能函数对明文字符串进行MD5编码</p>
<ol>
<li>输入待加密的明文字符串</li>
<li>对明文字符串进行填充</li>
<li>对填充后的明文字符串进行分块（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mi>q</mi></msub></mrow><annotation encoding="application/x-tex">Y_q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.969438em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span></span>）</li>
<li>使用预设的初始值初始化MD5缓冲区间（IV）</li>
<li>对各个分块字符串利用公式HMD5(<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><msub><mi>V</mi><mo stretchy="false">(</mo></msub><mi>i</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo separator="true">,</mo><msub><mi>Y</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">CV_(i-1), Y_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.03853em;vertical-align:-0.3551999999999999em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.34480000000000005em;"><span style="top:-2.5198em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mopen mtight">(</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3551999999999999em;"><span></span></span></span></span></span></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>)进行循环压缩，运算结果作为下一块的输入（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><msub><mi>V</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">CV_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>）</li>
<li>当所有的分块迭代完成后，输出结果<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><msub><mi>V</mi><mi>L</mi></msub></mrow><annotation encoding="application/x-tex">CV_L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.22222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">L</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，L表示最后一个分块的序号</li>
</ol>
<pre class="highlight"><code class="C++"><span class="hljs-comment">// MD5加密函数</span>
 <span class="hljs-function">string <span class="hljs-title">encode</span><span class="hljs-params">(string src)</span> </span>{
     vector&lt;<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>&gt; rec = <span class="hljs-built_in">padding</span>(src);
     <span class="hljs-keyword">for</span>(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; strlength/<span class="hljs-number">16</span>; i++) {
         <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> num[<span class="hljs-number">16</span>];
         <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">16</span>; j++) {
             num[j] = rec[i*<span class="hljs-number">16</span>+j];
         }
         <span class="hljs-built_in">iterateFunc</span>(num, <span class="hljs-number">16</span>);
     }
     <span class="hljs-keyword">return</span> format(tempA) + format(tempB) + format(tempC) + format(tempD);
 }
</code></pre>
</li>
</ol>
<h2 id="rsa实现信息加密解密"><a class="markdownIt-Anchor" href="#rsa实现信息加密解密"></a> RSA实现信息加密解密</h2>
<h3 id="rsa原理"><a class="markdownIt-Anchor" href="#rsa原理"></a> RSA原理</h3>
<ol>
<li>公钥<br>
选择两个不同的大素数p和q，n是二者的乘积，即$ n=pq <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>，使</mtext></mrow><annotation encoding="application/x-tex">，
 使</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">使</span></span></span></span>$ \varphi (n)=(p-1)(q-1) $$为欧拉函数。<br>
随机选取正整数e，使其满足$ gcd(e,\varphi (n))=1 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>，即</mtext><mi>e</mi><mtext>和</mtext></mrow><annotation encoding="application/x-tex">，即e和</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">即</span><span class="mord mathnormal">e</span><span class="mord cjk_fallback">和</span></span></span></span>\phi (n)$互素，则将(e,n)作为公钥。</li>
<li>私钥<br>
求出正数d，使其满足$ e \times d \equiv 1mod\varphi (n) $，则将(d,n)作为私钥。</li>
<li>加密算法<br>
对于明文m，由$ c \equiv m^emodn $，得到密文c，这里需要注意明文的分组方法。</li>
<li>解密算法<br>
对于密文c，由$ m \equiv c^dmodn $，得到明文m。</li>
</ol>
<h3 id="实现过程"><a class="markdownIt-Anchor" href="#实现过程"></a> 实现过程</h3>
<p>C++中大数需要用到gmp库,简单说下怎么安装</p>
<ul>
<li>
<p>Linux一行命令的事情</p>
<pre class="highlight"><code class="C++">sudo apt-get install libgmp-dev
</code></pre>
</li>
<li>
<p>Windows下需要MinGW,打开<code>MinGW Installation Manager</code>,左侧<code>All Packages</code>选中，然后找到<code>MinGW-gmp</code>，版本的话选择<code>dev</code>，右键<code>Mark for Installation</code>，然后菜单栏<code>Installation</code>选择<code>Apply Changes</code>即可，等待安装即可。<br>
<img src="https://s2.loli.net/2022/06/02/WMX1Tlh4Q2aUpLb.png" alt="20220602224307"></p>
</li>
</ul>
<ol>
<li>首先定义一个密钥对结构体：</li>
</ol>
<pre class="highlight"><code class="C++"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">key_pair</span> {
    string n;
    string d;
    <span class="hljs-type">int</span> e;
};
</code></pre>
<ol start="2">
<li>利用GMP的素性测试和数据生成完成两个大素数p，q的生成</li>
</ol>
<pre class="highlight"><code class="C++"><span class="hljs-comment">//生成两个大素数</span>
<span class="hljs-function"><span class="hljs-type">mpz_t</span> * <span class="hljs-title">gen_primes</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-type">gmp_randstate_t</span> grt;
    <span class="hljs-built_in">gmp_randinit_default</span>(grt);
    <span class="hljs-built_in">gmp_randseed_ui</span>(grt, <span class="hljs-built_in">time</span>(<span class="hljs-literal">NULL</span>));
    
    <span class="hljs-type">mpz_t</span> key_p, key_q;
    <span class="hljs-built_in">mpz_init</span>(key_p);
    <span class="hljs-built_in">mpz_init</span>(key_q);
 
    <span class="hljs-built_in">mpz_urandomb</span>(key_p, grt, KEY_LENGTH / <span class="hljs-number">2</span>);
    <span class="hljs-built_in">mpz_urandomb</span>(key_q, grt, KEY_LENGTH / <span class="hljs-number">2</span>); <span class="hljs-comment">//随机生成两个大整数</span>
 
    <span class="hljs-type">mpz_t</span> * result = <span class="hljs-keyword">new</span> <span class="hljs-type">mpz_t</span>[<span class="hljs-number">2</span>];
    <span class="hljs-built_in">mpz_init</span>(result[<span class="hljs-number">0</span>]);
    <span class="hljs-built_in">mpz_init</span>(result[<span class="hljs-number">1</span>]);
 
    <span class="hljs-built_in">mpz_nextprime</span>(result[<span class="hljs-number">0</span>], key_p);  <span class="hljs-comment">//使用GMP自带的素数生成函数</span>
    <span class="hljs-built_in">mpz_nextprime</span>(result[<span class="hljs-number">1</span>], key_q);
 
    <span class="hljs-built_in">mpz_clear</span>(key_p);
    <span class="hljs-built_in">mpz_clear</span>(key_q);
 
    <span class="hljs-keyword">return</span> result;    
}
</code></pre>
<ol start="3">
<li>根据RSA原理生成密钥对</li>
</ol>
<pre class="highlight"><code class="C++"><span class="hljs-comment">//生成密钥对</span>
<span class="hljs-function">key_pair * <span class="hljs-title">gen_key_pair</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-type">mpz_t</span> * primes = <span class="hljs-built_in">gen_primes</span>();
 
    <span class="hljs-type">mpz_t</span> key_n, key_e, key_f;
    <span class="hljs-built_in">mpz_init</span>(key_n);
    <span class="hljs-built_in">mpz_init</span>(key_f);
    <span class="hljs-built_in">mpz_init_set_ui</span>(key_e, <span class="hljs-number">65537</span>);    <span class="hljs-comment">//设置e为65537</span>
 
    <span class="hljs-built_in">mpz_mul</span>(key_n, primes[<span class="hljs-number">0</span>], primes[<span class="hljs-number">1</span>]);        <span class="hljs-comment">//计算n=p*q</span>
    <span class="hljs-built_in">mpz_sub_ui</span>(primes[<span class="hljs-number">0</span>], primes[<span class="hljs-number">0</span>], <span class="hljs-number">1</span>);        <span class="hljs-comment">//p=p-1</span>
    <span class="hljs-built_in">mpz_sub_ui</span>(primes[<span class="hljs-number">1</span>], primes[<span class="hljs-number">1</span>], <span class="hljs-number">1</span>);        <span class="hljs-comment">//q=q-1</span>
    <span class="hljs-built_in">mpz_mul</span>(key_f, primes[<span class="hljs-number">0</span>], primes[<span class="hljs-number">1</span>]);        <span class="hljs-comment">//计算欧拉函数φ(n)=(p-1)*(q-1)</span>
 
    <span class="hljs-type">mpz_t</span> key_d;    
    <span class="hljs-built_in">mpz_init</span>(key_d);
    <span class="hljs-built_in">mpz_invert</span>(key_d, key_e, key_f);   <span class="hljs-comment">//计算数论倒数</span>
 
    key_pair * result = <span class="hljs-keyword">new</span> key_pair;
 
    <span class="hljs-type">char</span> * buf_n = <span class="hljs-keyword">new</span> <span class="hljs-type">char</span>[KEY_LENGTH + <span class="hljs-number">10</span>];
    <span class="hljs-type">char</span> * buf_d = <span class="hljs-keyword">new</span> <span class="hljs-type">char</span>[KEY_LENGTH + <span class="hljs-number">10</span>];
 
    <span class="hljs-built_in">mpz_get_str</span>(buf_n, BASE, key_n);
    result-&gt;n = buf_n;
    <span class="hljs-built_in">mpz_get_str</span>(buf_d, BASE, key_d);
    result-&gt;d = buf_d;
    result-&gt;e = <span class="hljs-number">65537</span>;
 
    <span class="hljs-built_in">mpz_clear</span>(primes[<span class="hljs-number">0</span>]);   <span class="hljs-comment">//释放内存</span>
    <span class="hljs-built_in">mpz_clear</span>(primes[<span class="hljs-number">1</span>]);
    <span class="hljs-built_in">mpz_clear</span>(key_n);
    <span class="hljs-built_in">mpz_clear</span>(key_d);
    <span class="hljs-built_in">mpz_clear</span>(key_e);
    <span class="hljs-built_in">mpz_clear</span>(key_f);
    <span class="hljs-keyword">delete</span> []primes;

    <span class="hljs-keyword">return</span> result;
}
</code></pre>
<ol start="4">
<li>加密函数</li>
</ol>
<pre class="highlight"><code class="C++"><span class="hljs-function"><span class="hljs-type">char</span> * <span class="hljs-title">encrypt</span><span class="hljs-params">(<span class="hljs-type">char</span> * plain_text, <span class="hljs-type">const</span> <span class="hljs-type">char</span> * key_n, <span class="hljs-type">int</span> key_e)</span>  </span>{
    <span class="hljs-type">mpz_t</span> M, C1, n;
    <span class="hljs-built_in">mpz_init_set_str</span>(M, plain_text, BASE); 
    <span class="hljs-built_in">mpz_init_set_str</span>(n, key_n, BASE);
    <span class="hljs-built_in">mpz_init_set_ui</span>(C1, <span class="hljs-number">0</span>);
 
    <span class="hljs-built_in">mpz_powm_ui</span>(C1, M, key_e, n);    <span class="hljs-comment">//使用GMP中模幂计算函数</span>
 
    <span class="hljs-type">char</span> * result = <span class="hljs-keyword">new</span> <span class="hljs-type">char</span>[KEY_LENGTH + <span class="hljs-number">10</span>];
    <span class="hljs-built_in">mpz_get_str</span>(result, BASE, C1);
 
    <span class="hljs-keyword">return</span> result;
}
</code></pre>
<ol start="5">
<li>解密函数</li>
</ol>
<pre class="highlight"><code class="C++"><span class="hljs-function"><span class="hljs-type">char</span> * <span class="hljs-title">decrypt</span><span class="hljs-params">(<span class="hljs-type">char</span> * cipher_text, <span class="hljs-type">const</span> <span class="hljs-type">char</span> * key_n, <span class="hljs-type">const</span> <span class="hljs-type">char</span> * key_d)</span>  </span>{
    <span class="hljs-type">mpz_t</span> M, C1, n, d;
    <span class="hljs-built_in">mpz_init_set_str</span>(C1, cipher_text, BASE); 
    <span class="hljs-built_in">mpz_init_set_str</span>(n, key_n, BASE);
    <span class="hljs-built_in">mpz_init_set_str</span>(d, key_d, BASE);
    <span class="hljs-built_in">mpz_init</span>(M);
 
    <span class="hljs-built_in">mpz_powm</span>(M, C1, d, n);   <span class="hljs-comment">//使用GMP中的模幂计算函数</span>
 
    <span class="hljs-type">char</span> * result = <span class="hljs-keyword">new</span> <span class="hljs-type">char</span>[KEY_LENGTH + <span class="hljs-number">10</span>];
    <span class="hljs-built_in">mpz_get_str</span>(result, BASE, M);
 
    <span class="hljs-keyword">return</span> result;
}
</code></pre>
<h2 id="主程序"><a class="markdownIt-Anchor" href="#主程序"></a> 主程序</h2>
<ol>
<li>对A,B双方分别创建套接字，采用TCP，IPv4协议，输入自己的昵称之后经过TCP的三次握手即可连接成功</li>
<li>接下来进入身份确认环节，对AB双方发送的身份信息进行确认，利用对方昵称生成MD5密文，对比发送密文即可判断</li>
</ol>
<pre class="highlight"><code class="C++">    MD5 tmp_name;
    string tmp_s = tmp_name.<span class="hljs-built_in">encode</span>(client_name_tmp);
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; tmp_s.<span class="hljs-built_in">length</span>(); i++) {
        client_name[i] = tmp_s[i];
    }

    send_len = <span class="hljs-built_in">send</span>(client, client_name, <span class="hljs-built_in">sizeof</span>(client_name), <span class="hljs-number">0</span>);
    receive_len = <span class="hljs-built_in">recv</span>(client, server_name, <span class="hljs-built_in">sizeof</span>(server_name), <span class="hljs-number">0</span>);

    <span class="hljs-built_in">SetConsoleTextAttribute</span>(<span class="hljs-built_in">GetStdHandle</span>(STD_OUTPUT_HANDLE), FOREGROUND_INTENSITY|FOREGROUND_RED);
    cout &lt;&lt; endl;
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">IdConfirm</span>(server_name, <span class="hljs-string">"lkp1"</span>)) {
        cout &lt;&lt; <span class="hljs-string">"ID Confirm success, Let's chatting..."</span> &lt;&lt; endl &lt;&lt; endl;
    } <span class="hljs-keyword">else</span> {
        cout &lt;&lt; <span class="hljs-string">"ID Confirm failed, Conversation aborted..."</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }
</code></pre>
<ol start="3">
<li>身份确认成功之后即可进入发送环节，双方回合制发送信息
<ul>
<li>如果输入12582则表示当前回合结束，对方可发送信息</li>
<li>如果输入12581则表示想要退出聊天，则发送双方结束本次聊天</li>
<li>如果是其他信息，则相对信息进行加密然后发送，为了演示加密过程，在发送信息下方打印出密文和明文详情</li>
</ul>
</li>
</ol>
<h2 id="实验演示截图"><a class="markdownIt-Anchor" href="#实验演示截图"></a> 实验演示截图</h2>
<p>为了演示清晰，程序对文字进行了颜色处理，采用最原始聊天的蓝绿风格，并对身份确认环节进行红色处理。</p>
<p>默认双方昵称为lkp1和lkp2。</p>
<p>双方正常对话发送消息<br>
<img src="https://s2.loli.net/2022/06/02/XO8BGUYbve3xVuC.png" alt="20220602193209"></p>
<p>client结束本轮对话，由server发送消息<br>
<img src="https://s2.loli.net/2022/06/02/JeGg7Fcfu6vq8CE.png" alt="20220602193357"></p>
<p>server发送完消息之后输入12581结束本次对话<br>
<img src="https://s2.loli.net/2022/06/02/QT1hBk8ixKj7pGv.png" alt="20220602193553"></p>
<p>接下来演示身份错误环节<br>
<img src="https://s2.loli.net/2022/06/02/3DixqSKjXVzYZ9M.png" alt="20220602194244"></p>
<p>实验实现了目标里面的功能并且能够双向通信。</p>
<h2 id="源代码"><a class="markdownIt-Anchor" href="#源代码"></a> 源代码</h2>
<h3 id="文件树"><a class="markdownIt-Anchor" href="#文件树"></a> 文件树</h3>
<p>├───Client<br>
│——|——client.cpp<br>
│——|——client.exe<br>
│——|——client.h<br>
│——|——MD5.h<br>
├───Server<br>
│——|——generateKey.cpp<br>
│——|——generateKey.exe<br>
│——|——MD5.h<br>
│——|——server.cpp<br>
│——|——server.exe<br>
│——|——server.h</p>
<h3 id="md5h"><a class="markdownIt-Anchor" href="#md5h"></a> MD5.h</h3>
<pre class="highlight"><code class="C++"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> once</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdlib&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span></span>

<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

<span class="hljs-meta">#<span class="hljs-keyword">define</span> A 0x67452301</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> B 0xefcdab89</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> C 0x98badcfe</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> D 0x10325476</span>

<span class="hljs-type">const</span> <span class="hljs-type">char</span> str16[] = <span class="hljs-string">"0123456789abcdef"</span>;

<span class="hljs-type">const</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> T[] = {
    <span class="hljs-number">0xd76aa478</span>,<span class="hljs-number">0xe8c7b756</span>,<span class="hljs-number">0x242070db</span>,<span class="hljs-number">0xc1bdceee</span>,
    <span class="hljs-number">0xf57c0faf</span>,<span class="hljs-number">0x4787c62a</span>,<span class="hljs-number">0xa8304613</span>,<span class="hljs-number">0xfd469501</span>,
    <span class="hljs-number">0x698098d8</span>,<span class="hljs-number">0x8b44f7af</span>,<span class="hljs-number">0xffff5bb1</span>,<span class="hljs-number">0x895cd7be</span>,
    <span class="hljs-number">0x6b901122</span>,<span class="hljs-number">0xfd987193</span>,<span class="hljs-number">0xa679438e</span>,<span class="hljs-number">0x49b40821</span>,
    <span class="hljs-number">0xf61e2562</span>,<span class="hljs-number">0xc040b340</span>,<span class="hljs-number">0x265e5a51</span>,<span class="hljs-number">0xe9b6c7aa</span>,
    <span class="hljs-number">0xd62f105d</span>,<span class="hljs-number">0x02441453</span>,<span class="hljs-number">0xd8a1e681</span>,<span class="hljs-number">0xe7d3fbc8</span>,
    <span class="hljs-number">0x21e1cde6</span>,<span class="hljs-number">0xc33707d6</span>,<span class="hljs-number">0xf4d50d87</span>,<span class="hljs-number">0x455a14ed</span>,
    <span class="hljs-number">0xa9e3e905</span>,<span class="hljs-number">0xfcefa3f8</span>,<span class="hljs-number">0x676f02d9</span>,<span class="hljs-number">0x8d2a4c8a</span>,
    <span class="hljs-number">0xfffa3942</span>,<span class="hljs-number">0x8771f681</span>,<span class="hljs-number">0x6d9d6122</span>,<span class="hljs-number">0xfde5380c</span>,
    <span class="hljs-number">0xa4beea44</span>,<span class="hljs-number">0x4bdecfa9</span>,<span class="hljs-number">0xf6bb4b60</span>,<span class="hljs-number">0xbebfbc70</span>,
    <span class="hljs-number">0x289b7ec6</span>,<span class="hljs-number">0xeaa127fa</span>,<span class="hljs-number">0xd4ef3085</span>,<span class="hljs-number">0x04881d05</span>,
    <span class="hljs-number">0xd9d4d039</span>,<span class="hljs-number">0xe6db99e5</span>,<span class="hljs-number">0x1fa27cf8</span>,<span class="hljs-number">0xc4ac5665</span>,
    <span class="hljs-number">0xf4292244</span>,<span class="hljs-number">0x432aff97</span>,<span class="hljs-number">0xab9423a7</span>,<span class="hljs-number">0xfc93a039</span>,
    <span class="hljs-number">0x655b59c3</span>,<span class="hljs-number">0x8f0ccc92</span>,<span class="hljs-number">0xffeff47d</span>,<span class="hljs-number">0x85845dd1</span>,
    <span class="hljs-number">0x6fa87e4f</span>,<span class="hljs-number">0xfe2ce6e0</span>,<span class="hljs-number">0xa3014314</span>,<span class="hljs-number">0x4e0811a1</span>,
    <span class="hljs-number">0xf7537e82</span>,<span class="hljs-number">0xbd3af235</span>,<span class="hljs-number">0x2ad7d2bb</span>,<span class="hljs-number">0xeb86d391</span> };

<span class="hljs-type">const</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> s[] = { <span class="hljs-number">7</span>,<span class="hljs-number">12</span>,<span class="hljs-number">17</span>,<span class="hljs-number">22</span>,<span class="hljs-number">7</span>,<span class="hljs-number">12</span>,<span class="hljs-number">17</span>,<span class="hljs-number">22</span>,<span class="hljs-number">7</span>,<span class="hljs-number">12</span>,<span class="hljs-number">17</span>,<span class="hljs-number">22</span>,<span class="hljs-number">7</span>,<span class="hljs-number">12</span>,<span class="hljs-number">17</span>,<span class="hljs-number">22</span>,
                           <span class="hljs-number">5</span>,<span class="hljs-number">9</span>,<span class="hljs-number">14</span>,<span class="hljs-number">20</span>,<span class="hljs-number">5</span>,<span class="hljs-number">9</span>,<span class="hljs-number">14</span>,<span class="hljs-number">20</span>,<span class="hljs-number">5</span>,<span class="hljs-number">9</span>,<span class="hljs-number">14</span>,<span class="hljs-number">20</span>,<span class="hljs-number">5</span>,<span class="hljs-number">9</span>,<span class="hljs-number">14</span>,<span class="hljs-number">20</span>,
                           <span class="hljs-number">4</span>,<span class="hljs-number">11</span>,<span class="hljs-number">16</span>,<span class="hljs-number">23</span>,<span class="hljs-number">4</span>,<span class="hljs-number">11</span>,<span class="hljs-number">16</span>,<span class="hljs-number">23</span>,<span class="hljs-number">4</span>,<span class="hljs-number">11</span>,<span class="hljs-number">16</span>,<span class="hljs-number">23</span>,<span class="hljs-number">4</span>,<span class="hljs-number">11</span>,<span class="hljs-number">16</span>,<span class="hljs-number">23</span>,
                           <span class="hljs-number">6</span>,<span class="hljs-number">10</span>,<span class="hljs-number">15</span>,<span class="hljs-number">21</span>,<span class="hljs-number">6</span>,<span class="hljs-number">10</span>,<span class="hljs-number">15</span>,<span class="hljs-number">21</span>,<span class="hljs-number">6</span>,<span class="hljs-number">10</span>,<span class="hljs-number">15</span>,<span class="hljs-number">21</span>,<span class="hljs-number">6</span>,<span class="hljs-number">10</span>,<span class="hljs-number">15</span>,<span class="hljs-number">21</span>};

<span class="hljs-comment">// 第一部分是要进行 HASH 运算的原始明文，第二部分则是其对应的 HASH 值</span>
<span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">data</span>{
    string msg;
    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> hash[<span class="hljs-number">16</span>];
}tests[] = {
    { <span class="hljs-string">""</span>,
      { <span class="hljs-number">0xd4</span>, <span class="hljs-number">0x1d</span>, <span class="hljs-number">0x8c</span>, <span class="hljs-number">0xd9</span>, <span class="hljs-number">0x8f</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0xb2</span>, <span class="hljs-number">0x04</span>, 
        <span class="hljs-number">0xe9</span>, <span class="hljs-number">0x80</span>, <span class="hljs-number">0x09</span>, <span class="hljs-number">0x98</span>, <span class="hljs-number">0xec</span>, <span class="hljs-number">0xf8</span>, <span class="hljs-number">0x42</span>, <span class="hljs-number">0x7e</span> } },
    { <span class="hljs-string">"a"</span>,
      {<span class="hljs-number">0x0c</span>, <span class="hljs-number">0xc1</span>, <span class="hljs-number">0x75</span>, <span class="hljs-number">0xb9</span>, <span class="hljs-number">0xc0</span>, <span class="hljs-number">0xf1</span>, <span class="hljs-number">0xb6</span>, <span class="hljs-number">0xa8</span>, 
       <span class="hljs-number">0x31</span>, <span class="hljs-number">0xc3</span>, <span class="hljs-number">0x99</span>, <span class="hljs-number">0xe2</span>, <span class="hljs-number">0x69</span>, <span class="hljs-number">0x77</span>, <span class="hljs-number">0x26</span>, <span class="hljs-number">0x61</span> } },
    { <span class="hljs-string">"abc"</span>,
      { <span class="hljs-number">0x90</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x50</span>, <span class="hljs-number">0x98</span>, <span class="hljs-number">0x3c</span>, <span class="hljs-number">0xd2</span>, <span class="hljs-number">0x4f</span>, <span class="hljs-number">0xb0</span>, 
        <span class="hljs-number">0xd6</span>, <span class="hljs-number">0x96</span>, <span class="hljs-number">0x3f</span>, <span class="hljs-number">0x7d</span>, <span class="hljs-number">0x28</span>, <span class="hljs-number">0xe1</span>, <span class="hljs-number">0x7f</span>, <span class="hljs-number">0x72</span> } },
    { <span class="hljs-string">"message digest"</span>, 
      { <span class="hljs-number">0xf9</span>, <span class="hljs-number">0x6b</span>, <span class="hljs-number">0x69</span>, <span class="hljs-number">0x7d</span>, <span class="hljs-number">0x7c</span>, <span class="hljs-number">0xb7</span>, <span class="hljs-number">0x93</span>, <span class="hljs-number">0x8d</span>, 
        <span class="hljs-number">0x52</span>, <span class="hljs-number">0x5a</span>, <span class="hljs-number">0x2f</span>, <span class="hljs-number">0x31</span>, <span class="hljs-number">0xaa</span>, <span class="hljs-number">0xf1</span>, <span class="hljs-number">0x61</span>, <span class="hljs-number">0xd0</span> } }, 
    { <span class="hljs-string">"abcdefghijklmnopqrstuvwxyz"</span>,
      { <span class="hljs-number">0xc3</span>, <span class="hljs-number">0xfc</span>, <span class="hljs-number">0xd3</span>, <span class="hljs-number">0xd7</span>, <span class="hljs-number">0x61</span>, <span class="hljs-number">0x92</span>, <span class="hljs-number">0xe4</span>, <span class="hljs-number">0x00</span>, 
        <span class="hljs-number">0x7d</span>, <span class="hljs-number">0xfb</span>, <span class="hljs-number">0x49</span>, <span class="hljs-number">0x6c</span>, <span class="hljs-number">0xca</span>, <span class="hljs-number">0x67</span>, <span class="hljs-number">0xe1</span>, <span class="hljs-number">0x3b</span> } },
    { <span class="hljs-string">"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"</span>,
      { <span class="hljs-number">0xd1</span>, <span class="hljs-number">0x74</span>, <span class="hljs-number">0xab</span>, <span class="hljs-number">0x98</span>, <span class="hljs-number">0xd2</span>, <span class="hljs-number">0x77</span>, <span class="hljs-number">0xd9</span>, <span class="hljs-number">0xf5</span>, 
        <span class="hljs-number">0xa5</span>, <span class="hljs-number">0x61</span>, <span class="hljs-number">0x1c</span>, <span class="hljs-number">0x2c</span>, <span class="hljs-number">0x9f</span>, <span class="hljs-number">0x41</span>, <span class="hljs-number">0x9d</span>, <span class="hljs-number">0x9f</span> } },
    { <span class="hljs-string">"12345678901234567890123456789012345678901234567890123456789012345678901234567890"</span>,
      { <span class="hljs-number">0x57</span>, <span class="hljs-number">0xed</span>, <span class="hljs-number">0xf4</span>, <span class="hljs-number">0xa2</span>, <span class="hljs-number">0x2b</span>, <span class="hljs-number">0xe3</span>, <span class="hljs-number">0xc9</span>, <span class="hljs-number">0x55</span>, 
        <span class="hljs-number">0xac</span>, <span class="hljs-number">0x49</span>, <span class="hljs-number">0xda</span>, <span class="hljs-number">0x2e</span>, <span class="hljs-number">0x21</span>, <span class="hljs-number">0x07</span>, <span class="hljs-number">0xb6</span>, <span class="hljs-number">0x7a</span> } },

};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MD5</span> {
<span class="hljs-keyword">private</span>:
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> tempA, tempB, tempC, tempD, strlength;
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">MD5</span>() {
        tempA = A;
        tempB = B;
        tempC = C;
        tempD = D;
        strlength = <span class="hljs-number">0</span>;
    }
    <span class="hljs-comment">// 填充字符串</span>
    <span class="hljs-function">vector&lt;<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>&gt; <span class="hljs-title">padding</span><span class="hljs-params">(string src)</span> </span>{
        <span class="hljs-comment">// 以512位,64个字节为一组</span>
        <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> num = ((src.<span class="hljs-built_in">length</span>() + <span class="hljs-number">8</span>) / <span class="hljs-number">64</span>) + <span class="hljs-number">1</span>;
        <span class="hljs-function">vector&lt;<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>&gt; <span class="hljs-title">rec</span><span class="hljs-params">(num*<span class="hljs-number">16</span>)</span></span>;
        strlength = num*<span class="hljs-number">16</span>;
        <span class="hljs-keyword">for</span>(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; src.<span class="hljs-built_in">length</span>(); i++){
            <span class="hljs-comment">// 一个unsigned int对应4个字节，保存4个字符信息</span>
            rec[i&gt;&gt;<span class="hljs-number">2</span>] |= (<span class="hljs-type">int</span>)(src[i]) &lt;&lt; ((i % <span class="hljs-number">4</span>) * <span class="hljs-number">8</span>);
        }
        <span class="hljs-comment">// 补充1000...000</span>
        rec[src.<span class="hljs-built_in">length</span>() &gt;&gt; <span class="hljs-number">2</span>] |= (<span class="hljs-number">0x80</span> &lt;&lt; ((src.<span class="hljs-built_in">length</span>() % <span class="hljs-number">4</span>)*<span class="hljs-number">8</span>));
        <span class="hljs-comment">// 填充原文长度</span>
        rec[rec.<span class="hljs-built_in">size</span>()<span class="hljs-number">-2</span>] = (src.<span class="hljs-built_in">length</span>() &lt;&lt; <span class="hljs-number">3</span>);
        <span class="hljs-keyword">return</span> rec;
    }
    <span class="hljs-comment">// F函数</span>
    <span class="hljs-function"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title">F</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> b, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> c, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> d)</span> </span>{
        <span class="hljs-keyword">return</span> (b &amp; c) | ((~b) &amp; d);
    }
    <span class="hljs-comment">// G函数</span>
    <span class="hljs-function"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title">G</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> b, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> c, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> d)</span> </span>{
        <span class="hljs-keyword">return</span> (b &amp; d) | (c &amp; (~d));
    }
    <span class="hljs-comment">// H函数</span>
    <span class="hljs-function"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title">H</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> b, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> c, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> d)</span> </span>{
        <span class="hljs-keyword">return</span> b ^ c ^ d;
    }
    <span class="hljs-comment">// I函数</span>
    <span class="hljs-function"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title">I</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> b, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> c, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> d)</span> </span>{
        <span class="hljs-keyword">return</span> c ^ (b | (~d));
    }
    <span class="hljs-comment">// 移位操作函数</span>
    <span class="hljs-function"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title">shift</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> a, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> n)</span> </span>{
        <span class="hljs-keyword">return</span> (a &lt;&lt; n) | (a &gt;&gt; (<span class="hljs-number">32</span> - n));
    }
    <span class="hljs-comment">// 循环压缩</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">iterateFunc</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>* X, <span class="hljs-type">int</span> size = <span class="hljs-number">16</span>)</span> </span>{
        <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> a = tempA,
                     b = tempB,
                     c = tempC,
                     d = tempD,
                     rec = <span class="hljs-number">0</span>,
                     g, k;
        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">64</span>; i++) {
            <span class="hljs-keyword">if</span>(i &lt; <span class="hljs-number">16</span>) {
                <span class="hljs-comment">// F迭代</span>
                g = <span class="hljs-built_in">F</span>(b, c, d);
                k = i;
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(i &lt; <span class="hljs-number">32</span>) {
                <span class="hljs-comment">// G迭代</span>
                g = <span class="hljs-built_in">G</span>(b, c, d);
                k = (<span class="hljs-number">1</span> + <span class="hljs-number">5</span>*i) % <span class="hljs-number">16</span>;
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(i &lt; <span class="hljs-number">48</span>) {
                <span class="hljs-comment">// H迭代</span>
                g = <span class="hljs-built_in">H</span>(b, c, d);
                k = (<span class="hljs-number">5</span> + <span class="hljs-number">3</span>*i) % <span class="hljs-number">16</span>;
            }
            <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// I迭代</span>
                g = <span class="hljs-built_in">I</span>(b, c, d);
                k = (<span class="hljs-number">7</span>*i) % <span class="hljs-number">16</span>;
            }
            rec = d;
            d = c;
            c = b;
            b = b + <span class="hljs-built_in">shift</span>(a + g + X[k] + T[i], s[i]);
            a = rec;
        }
        tempA += a;
        tempB += b;
        tempC += c;
        tempD += d;
    }
    <span class="hljs-comment">// 整理输出</span>
    <span class="hljs-function">string <span class="hljs-title">format</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> num)</span> </span>{
        string res = <span class="hljs-string">""</span>;
        <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> base = <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">8</span>;
        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++) {
            string tmp = <span class="hljs-string">""</span>;
            <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> b = (num &gt;&gt; (i * <span class="hljs-number">8</span>)) % base &amp; <span class="hljs-number">0xff</span>;
            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">2</span>; j++) {
                tmp = str16[b%<span class="hljs-number">16</span>] + tmp;
                b /= <span class="hljs-number">16</span>;
            }
            res += tmp;
        }
        <span class="hljs-keyword">return</span> res;
    }
    <span class="hljs-comment">// 编码函数</span>
    <span class="hljs-function">string <span class="hljs-title">encode</span><span class="hljs-params">(string src)</span> </span>{
        vector&lt;<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>&gt; rec = <span class="hljs-built_in">padding</span>(src);
        <span class="hljs-keyword">for</span>(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; strlength/<span class="hljs-number">16</span>; i++) {
            <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> num[<span class="hljs-number">16</span>];
            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">16</span>; j++) {
                num[j] = rec[i*<span class="hljs-number">16</span>+j];
            }
            <span class="hljs-built_in">iterateFunc</span>(num, <span class="hljs-number">16</span>);
        }
        <span class="hljs-keyword">return</span> format(tempA) + format(tempB) + format(tempC) + format(tempD);
    }
};
</code></pre>
<h3 id="generatekeycpp"><a class="markdownIt-Anchor" href="#generatekeycpp"></a> generateKey.cpp</h3>
<pre class="highlight"><code class="C++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdio&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;ctime&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstring&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdlib&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;gmp.h&gt;</span></span>
 
<span class="hljs-meta">#<span class="hljs-keyword">define</span> KEY_LENGTH 2048  <span class="hljs-comment">//公钥的长度</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> BASE 16    <span class="hljs-comment">//输入输出的数字进制</span></span>
 
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;
 
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">key_pair</span> {
    string n;
    string d;
    <span class="hljs-type">int</span> e;
};
 
<span class="hljs-comment">//生成两个大素数</span>
<span class="hljs-function"><span class="hljs-type">mpz_t</span> * <span class="hljs-title">gen_primes</span><span class="hljs-params">()</span>
</span>{                                        
    <span class="hljs-type">gmp_randstate_t</span> grt;                
    <span class="hljs-built_in">gmp_randinit_default</span>(grt);    
    <span class="hljs-built_in">gmp_randseed_ui</span>(grt, <span class="hljs-built_in">time</span>(<span class="hljs-literal">NULL</span>));    
    
    <span class="hljs-type">mpz_t</span> key_p, key_q;
    <span class="hljs-built_in">mpz_init</span>(key_p);
    <span class="hljs-built_in">mpz_init</span>(key_q);
 
    <span class="hljs-built_in">mpz_urandomb</span>(key_p, grt, KEY_LENGTH / <span class="hljs-number">2</span>);        
    <span class="hljs-built_in">mpz_urandomb</span>(key_q, grt, KEY_LENGTH / <span class="hljs-number">2</span>);    <span class="hljs-comment">//随机生成两个大整数</span>
 
    <span class="hljs-type">mpz_t</span> * result = <span class="hljs-keyword">new</span> <span class="hljs-type">mpz_t</span>[<span class="hljs-number">2</span>];
    <span class="hljs-built_in">mpz_init</span>(result[<span class="hljs-number">0</span>]);
    <span class="hljs-built_in">mpz_init</span>(result[<span class="hljs-number">1</span>]);
 
    <span class="hljs-built_in">mpz_nextprime</span>(result[<span class="hljs-number">0</span>], key_p);  <span class="hljs-comment">//使用GMP自带的素数生成函数</span>
    <span class="hljs-built_in">mpz_nextprime</span>(result[<span class="hljs-number">1</span>], key_q);
 
    <span class="hljs-built_in">mpz_clear</span>(key_p);
    <span class="hljs-built_in">mpz_clear</span>(key_q);
 
    <span class="hljs-keyword">return</span> result;    
}
 
<span class="hljs-comment">//生成密钥对</span>
<span class="hljs-function">key_pair * <span class="hljs-title">gen_key_pair</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-type">mpz_t</span> * primes = <span class="hljs-built_in">gen_primes</span>();
 
    <span class="hljs-type">mpz_t</span> key_n, key_e, key_f;
    <span class="hljs-built_in">mpz_init</span>(key_n);
    <span class="hljs-built_in">mpz_init</span>(key_f);
    <span class="hljs-built_in">mpz_init_set_ui</span>(key_e, <span class="hljs-number">65537</span>);    <span class="hljs-comment">//设置e为65537</span>
 
    <span class="hljs-built_in">mpz_mul</span>(key_n, primes[<span class="hljs-number">0</span>], primes[<span class="hljs-number">1</span>]);        <span class="hljs-comment">//计算n=p*q</span>
    <span class="hljs-built_in">mpz_sub_ui</span>(primes[<span class="hljs-number">0</span>], primes[<span class="hljs-number">0</span>], <span class="hljs-number">1</span>);        <span class="hljs-comment">//p=p-1</span>
    <span class="hljs-built_in">mpz_sub_ui</span>(primes[<span class="hljs-number">1</span>], primes[<span class="hljs-number">1</span>], <span class="hljs-number">1</span>);        <span class="hljs-comment">//q=q-1</span>
    <span class="hljs-built_in">mpz_mul</span>(key_f, primes[<span class="hljs-number">0</span>], primes[<span class="hljs-number">1</span>]);        <span class="hljs-comment">//计算欧拉函数φ(n)=(p-1)*(q-1)</span>
 
    <span class="hljs-type">mpz_t</span> key_d;    
    <span class="hljs-built_in">mpz_init</span>(key_d);
    <span class="hljs-built_in">mpz_invert</span>(key_d, key_e, key_f);   <span class="hljs-comment">//计算数论倒数</span>
 
    key_pair * result = <span class="hljs-keyword">new</span> key_pair;
 
    <span class="hljs-type">char</span> * buf_n = <span class="hljs-keyword">new</span> <span class="hljs-type">char</span>[KEY_LENGTH + <span class="hljs-number">10</span>];
    <span class="hljs-type">char</span> * buf_d = <span class="hljs-keyword">new</span> <span class="hljs-type">char</span>[KEY_LENGTH + <span class="hljs-number">10</span>];
 
    <span class="hljs-built_in">mpz_get_str</span>(buf_n, BASE, key_n);
    result-&gt;n = buf_n;
    <span class="hljs-built_in">mpz_get_str</span>(buf_d, BASE, key_d);
    result-&gt;d = buf_d;
    result-&gt;e = <span class="hljs-number">65537</span>;
 
    <span class="hljs-built_in">mpz_clear</span>(primes[<span class="hljs-number">0</span>]);   <span class="hljs-comment">//释放内存</span>
    <span class="hljs-built_in">mpz_clear</span>(primes[<span class="hljs-number">1</span>]);
    <span class="hljs-built_in">mpz_clear</span>(key_n);
    <span class="hljs-built_in">mpz_clear</span>(key_d);
    <span class="hljs-built_in">mpz_clear</span>(key_e);
    <span class="hljs-built_in">mpz_clear</span>(key_f);
    <span class="hljs-keyword">delete</span> []primes;

    <span class="hljs-keyword">return</span> result;
}

<span class="hljs-function">key_pair* <span class="hljs-title">getKey</span> <span class="hljs-params">(<span class="hljs-type">char</span> name)</span> </span>{
    key_pair * p = <span class="hljs-built_in">gen_key_pair</span>();
 
    cout &lt;&lt; <span class="hljs-string">"n = "</span> &lt;&lt; p-&gt;n &lt;&lt; endl;
    cout &lt;&lt; <span class="hljs-string">"d = "</span> &lt;&lt; p-&gt;d &lt;&lt; endl;
    cout &lt;&lt; <span class="hljs-string">"e = "</span> &lt;&lt; p-&gt;e &lt;&lt; endl;

    cout &lt;&lt; name &lt;&lt; <span class="hljs-string">"s public key is:("</span> &lt;&lt; p-&gt;n &lt;&lt; <span class="hljs-string">", "</span> &lt;&lt; p-&gt;e &lt;&lt; <span class="hljs-string">")"</span> &lt;&lt; endl &lt;&lt; endl; <span class="hljs-comment">//输出公钥(n, e)</span>
    cout &lt;&lt; name &lt;&lt; <span class="hljs-string">"s private key is:("</span> &lt;&lt; p-&gt;n &lt;&lt; <span class="hljs-string">", "</span> &lt;&lt; p-&gt;d &lt;&lt; <span class="hljs-string">")"</span> &lt;&lt; endl &lt;&lt; endl; <span class="hljs-comment">//输出私钥(n, d)</span>
    <span class="hljs-keyword">return</span> p;
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">generateABKey</span><span class="hljs-params">()</span> </span>{
    key_pair * A = <span class="hljs-built_in">getKey</span>(<span class="hljs-string">'A'</span>);
    key_pair * B = <span class="hljs-built_in">getKey</span>(<span class="hljs-string">'B'</span>);
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{        
    <span class="hljs-built_in">generateABKey</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h3 id="serverh"><a class="markdownIt-Anchor" href="#serverh"></a> Server.h</h3>
<pre class="highlight"><code class="C++"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> once</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdio&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;ctime&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstring&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdlib&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;gmp.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"MD5.h"</span></span>
 
<span class="hljs-meta">#<span class="hljs-keyword">define</span> KEY_LENGTH 2048  <span class="hljs-comment">//公钥的长度</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> BASE 16    <span class="hljs-comment">//输入输出的数字进制</span></span>
 
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;
 
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">key_pair</span>
{
    string n;
    string d;
    <span class="hljs-type">int</span> e;
    string k;
};

key_pair* key = <span class="hljs-keyword">new</span> key_pair;

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">keyInit</span><span class="hljs-params">()</span> </span>{
    key-&gt;n = <span class="hljs-string">"42ed95a8c26d10e856d7ac17e9451037457d5f6e66b824471229ac1422d28f868d6699492c7c31b6d10ed32ee6ad3cbb00bbefe2e76de75b924342781f3f67fd09a3d67c639363c97af569fb52863901f1b6b5e7901c00c989dd7847fc7f55989bf4775969254c2dc0d8e9f7e7dbb5e158c97f5d7d18de47766ee1efb2a3d7e899d019240701e2dec5ca8473a34cea6b6dcb62cff25d40858df7b37e3c14bac390d26926cf30c977b7417130bced9fcce5b7ff6923ab21652a2bf73c3dd0c40a3398f02261e9bd75a24134264412b3371c03daa715e2ad74c20d0ab895ab7025b0bec1eea316146127a5a6d97aa4f09c82624d7f897ef93a7d114cc0757d4253"</span>;
    key-&gt;d = <span class="hljs-string">"1f3c797be0fa3c48e3b716e7b60478b40327a77184596efd089a1068f973a26edef1c29ae73b338caa77abd298f0c38657aa5f245c74ebe4ce17bc1f0a1e72af235fa70c3901223277c3b06a0eb2fc4a4f00c25747e7f9ea16011a5126a45b53b57ddc720b63cff10eaf6e4b38984f83d4077efd281482318231f01b0a19f3fb58f835baa189bd387e4ba9d7da4b597d84fdcffc22e707be41adb6ca20f05787cf7e6d1ef27fb8e18ecb4d7ba9f544488e0d109cad4e7befa47020b8e568cf509543fc972b79aa1a8fb49149b517384b5b458f7a8052c299e3605fe12c786cd80f3fd8a2dc7f0ae67ecf1c3b2212d2b21fe5b7588a2d977af636cc461ec78c99"</span>;
    key-&gt;e = <span class="hljs-number">65537</span>;
    key-&gt;k = <span class="hljs-string">"77232546f0b2983adb0ab839b04b81278bcbdc2d34f06a248333cd33e3c139fb578ca19b389e0253fa6f3b3b41e2fd0f6f1fa7e94499fa212afa7f0b2a89f8681dd00e3207c09586c7c6f923016455b652e93ae4bf3b905d7e955fb3102286d9947247f1e75921aaa35840ad3359091e701c167f28be312116c43a13946d0c8d5da8fa21938be40c1f60821d45ef8530d6e24adfd5ab2a1a6ad34545d83c5fcca02a7f29541d6d4cf29778593958957c9b4ad9693289db7743a05bf88480473dc028e4f8e32ff6bdd206910b971ae00c649038aa59baebe8b7af542e9a9b65f69e7efcc17d6a88244cc9520d4b009371c268058e62d707561825ad5a98a81d11"</span>;
}

<span class="hljs-comment">//加密函数</span>
<span class="hljs-function"><span class="hljs-type">char</span> * <span class="hljs-title">encrypt</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> * plain_text, <span class="hljs-type">const</span> <span class="hljs-type">char</span> * key_n, <span class="hljs-type">int</span> key_e)</span>  
</span>{
    <span class="hljs-type">mpz_t</span> M, C1, n;
    <span class="hljs-built_in">mpz_init_set_str</span>(M, plain_text, BASE); 
    <span class="hljs-built_in">mpz_init_set_str</span>(n, key_n, BASE);
    <span class="hljs-built_in">mpz_init_set_ui</span>(C1, <span class="hljs-number">0</span>);
 
    <span class="hljs-built_in">mpz_powm_ui</span>(C1, M, key_e, n);    <span class="hljs-comment">//使用GMP中模幂计算函数</span>
 
    <span class="hljs-type">char</span> * result = <span class="hljs-keyword">new</span> <span class="hljs-type">char</span>[KEY_LENGTH + <span class="hljs-number">10</span>];
    <span class="hljs-built_in">mpz_get_str</span>(result, BASE, C1);
 
    <span class="hljs-keyword">return</span> result;
}
 
<span class="hljs-comment">//解密函数</span>
<span class="hljs-function"><span class="hljs-type">char</span> * <span class="hljs-title">decrypt</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> * cipher_text, <span class="hljs-type">const</span> <span class="hljs-type">char</span> * key_n, <span class="hljs-type">const</span> <span class="hljs-type">char</span> * key_d)</span>  
</span>{
    <span class="hljs-type">mpz_t</span> M, C1, n, d;
    <span class="hljs-built_in">mpz_init_set_str</span>(C1, cipher_text, BASE); 
    <span class="hljs-built_in">mpz_init_set_str</span>(n, key_n, BASE);
    <span class="hljs-built_in">mpz_init_set_str</span>(d, key_d, BASE);
    <span class="hljs-built_in">mpz_init</span>(M);
 
    <span class="hljs-built_in">mpz_powm</span>(M, C1, d, n);   <span class="hljs-comment">//使用GMP中的模幂计算函数</span>
 
    <span class="hljs-type">char</span> * result = <span class="hljs-keyword">new</span> <span class="hljs-type">char</span>[KEY_LENGTH + <span class="hljs-number">10</span>];
    <span class="hljs-built_in">mpz_get_str</span>(result, BASE, M);
 
    <span class="hljs-keyword">return</span> result;
}

<span class="hljs-function">string <span class="hljs-title">getTime</span><span class="hljs-params">()</span> </span>{<span class="hljs-comment">//时间函数，返回一个时间戳</span>
    <span class="hljs-type">time_t</span> timep;
    <span class="hljs-built_in">time</span>(&amp;timep);
    <span class="hljs-type">char</span> tmp[<span class="hljs-number">64</span>];
    <span class="hljs-built_in">strftime</span>(tmp, <span class="hljs-built_in">sizeof</span>(tmp), <span class="hljs-string">"%Y-%m-%d %H:%M:%S"</span>, <span class="hljs-built_in">localtime</span>(&amp;timep));
    <span class="hljs-keyword">return</span> tmp;
}

<span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">IdConfirm</span> <span class="hljs-params">(string ID, string name)</span> </span>{
    MD5 tmp;
    string hash = tmp.<span class="hljs-built_in">encode</span>(name);
    <span class="hljs-keyword">if</span> (ID.<span class="hljs-built_in">compare</span>(hash)) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<h3 id="servercpp"><a class="markdownIt-Anchor" href="#servercpp"></a> Server.cpp</h3>
<pre class="highlight"><code class="C++"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;winsock.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;time.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">"windows.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"server.h"</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(lib,<span class="hljs-string">"ws2_32.lib"</span>)<span class="hljs-comment">//加载ws2_32.dll</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> BUF_SIZE 4096   <span class="hljs-comment">//指定聊天信息缓冲区大小</span></span>

<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    WSADATA wsaData;
    <span class="hljs-built_in">WSAStartup</span>(<span class="hljs-built_in">MAKEWORD</span>(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>), &amp;wsaData);

    SOCKET server = <span class="hljs-built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);<span class="hljs-comment">//创建server套接字，采用ipv4地址，默认TCP协议</span>

    sockaddr_in server_addr;
    <span class="hljs-built_in">memset</span>(&amp;server_addr, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(server_addr));
    server_addr.sin_family = AF_INET;<span class="hljs-comment">//套接字地址也采用IPv4地址</span>
    server_addr.sin_addr.S_un.S_addr = <span class="hljs-built_in">inet_addr</span>(<span class="hljs-string">"127.0.0.1"</span>);<span class="hljs-comment">//本机地址</span>
    server_addr.sin_port = <span class="hljs-built_in">htons</span>(<span class="hljs-number">1234</span>);<span class="hljs-comment">//端口号</span>
    <span class="hljs-built_in">bind</span>(server, (SOCKADDR*)&amp;server_addr, <span class="hljs-built_in">sizeof</span>(server_addr));<span class="hljs-comment">//将套接字和地址绑定</span>

    <span class="hljs-type">char</span> server_name[<span class="hljs-number">2048</span>] = { <span class="hljs-number">0</span> };<span class="hljs-comment">//申请一个2048字节的缓冲区，用于储存服务器的名称</span>
    <span class="hljs-type">char</span> server_name_tmp[<span class="hljs-number">2048</span>] = { <span class="hljs-number">0</span> };
    cout &lt;&lt; <span class="hljs-built_in">getTime</span>() &lt;&lt; <span class="hljs-string">" "</span> &lt;&lt; <span class="hljs-string">"Please enter your nickname:"</span>;
    cin.<span class="hljs-built_in">getline</span>(server_name_tmp, <span class="hljs-number">2048</span>);  <span class="hljs-comment">//gets()  </span>
    cout &lt;&lt; <span class="hljs-built_in">getTime</span>() &lt;&lt; <span class="hljs-string">" "</span> &lt;&lt; <span class="hljs-string">"Waiting for connection...\n"</span>;

    <span class="hljs-built_in">listen</span>(server, <span class="hljs-number">1</span>);<span class="hljs-comment">//进入监听状态，数字1表示队列中只能存在一个请求</span>

    <span class="hljs-comment">/*服务器已经初始化完毕，等待客户机连接*/</span>

    <span class="hljs-type">char</span> client_name[<span class="hljs-number">2048</span>] = { <span class="hljs-number">0</span> };
    SOCKET client;
    SOCKADDR_IN client_addr;
    <span class="hljs-type">int</span> client_addr_len = <span class="hljs-built_in">sizeof</span>(client_addr);

    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        client = <span class="hljs-built_in">accept</span>(server, (SOCKADDR*)&amp;client_addr, &amp;client_addr_len);
        <span class="hljs-keyword">if</span> (client == INVALID_SOCKET) {
            cout &lt;&lt; <span class="hljs-built_in">getTime</span>() &lt;&lt; <span class="hljs-string">" "</span> &lt;&lt; <span class="hljs-string">"Connection failed.\n"</span> &lt;&lt; <span class="hljs-built_in">WSAGetLastError</span>();
        }
        <span class="hljs-keyword">else</span> {
            cout &lt;&lt; <span class="hljs-built_in">getTime</span>() &lt;&lt; <span class="hljs-string">" "</span> &lt;&lt; <span class="hljs-string">"Connection succeeded!!!\n"</span>;
            <span class="hljs-keyword">break</span>;
        }
    }
    
    <span class="hljs-type">char</span> buffer[BUF_SIZE] = { <span class="hljs-number">0</span> };
    <span class="hljs-type">char</span> buffer_send[BUF_SIZE + <span class="hljs-number">100</span>] = { <span class="hljs-number">0</span> };
    <span class="hljs-type">char</span> buffer_receive[BUF_SIZE + <span class="hljs-number">100</span>] = { <span class="hljs-number">0</span> };
    <span class="hljs-type">int</span> receive_len = <span class="hljs-number">0</span>;
    <span class="hljs-type">int</span> send_len = <span class="hljs-number">0</span>;
    <span class="hljs-comment">/*通过建立的连接进行通信*/</span>
    <span class="hljs-comment">//发送和接受客户端与服务端的名字  </span>

    MD5 tmp_name;
    string tmp_s = tmp_name.<span class="hljs-built_in">encode</span>(server_name_tmp);
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; tmp_s.<span class="hljs-built_in">length</span>(); i++) {
        server_name[i] = tmp_s[i];
    }
    send_len = <span class="hljs-built_in">send</span>(client, server_name, <span class="hljs-built_in">sizeof</span>(server_name), <span class="hljs-number">0</span>);
    receive_len = <span class="hljs-built_in">recv</span>(client, client_name, <span class="hljs-built_in">sizeof</span>(client_name), <span class="hljs-number">0</span>);
    
    <span class="hljs-built_in">SetConsoleTextAttribute</span>(<span class="hljs-built_in">GetStdHandle</span>(STD_OUTPUT_HANDLE), FOREGROUND_INTENSITY|FOREGROUND_RED);
    cout &lt;&lt; endl;
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">IdConfirm</span>(client_name, <span class="hljs-string">"lkp2"</span>)) {
        cout &lt;&lt; <span class="hljs-string">"ID Confirm success, Let's chatting..."</span> &lt;&lt; endl &lt;&lt; endl;
    } <span class="hljs-keyword">else</span> {
        cout &lt;&lt; <span class="hljs-string">"ID Confirm failed, Conversation aborted..."</span>;
        <span class="hljs-built_in">SetConsoleTextAttribute</span>(<span class="hljs-built_in">GetStdHandle</span>(STD_OUTPUT_HANDLE),FOREGROUND_INTENSITY|FOREGROUND_RED|FOREGROUND_GREEN|FOREGROUND_BLUE);
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }

    <span class="hljs-built_in">keyInit</span>();

    <span class="hljs-built_in">SetConsoleTextAttribute</span>(<span class="hljs-built_in">GetStdHandle</span>(STD_OUTPUT_HANDLE),FOREGROUND_INTENSITY|FOREGROUND_RED|FOREGROUND_GREEN|FOREGROUND_BLUE);
    cout &lt;&lt; <span class="hljs-string">"Please enter the message(just number) you want to send, or enter \"12582\" to abort this conversation, or enter \"12581\" to abort this chat"</span> &lt;&lt; endl;

    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {<span class="hljs-comment">//接收消息</span>
            <span class="hljs-built_in">memset</span>(buffer_receive, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(buffer_receive));<span class="hljs-comment">//初始化缓冲区  </span>
            receive_len = <span class="hljs-built_in">recv</span>(client, buffer_receive, <span class="hljs-built_in">sizeof</span>(buffer_receive), <span class="hljs-number">0</span>);
            <span class="hljs-comment">//string tmp(buffer_receive);</span>
            string tmp = <span class="hljs-built_in">decrypt</span>(buffer_receive, key-&gt;n.<span class="hljs-built_in">data</span>(), key-&gt;d.<span class="hljs-built_in">data</span>());
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(buffer_receive, <span class="hljs-string">"12581"</span>) == <span class="hljs-number">0</span>) {<span class="hljs-comment">//如果聊天内容中含有12581，则退出聊天，关闭socket</span>
                <span class="hljs-built_in">SetConsoleTextAttribute</span>(<span class="hljs-built_in">GetStdHandle</span>(STD_OUTPUT_HANDLE), FOREGROUND_INTENSITY);
                cout &lt;&lt; <span class="hljs-string">"The program will exit in 3 seconds..."</span> &lt;&lt; endl;
                <span class="hljs-built_in">Sleep</span>(<span class="hljs-number">1000</span>);
                cout &lt;&lt; <span class="hljs-string">"The program will exit in 2 seconds..."</span> &lt;&lt; endl;
                <span class="hljs-built_in">Sleep</span>(<span class="hljs-number">1000</span>);
                cout &lt;&lt; <span class="hljs-string">"The program will exit in 1 seconds..."</span>;
                <span class="hljs-built_in">Sleep</span>(<span class="hljs-number">1000</span>);
                <span class="hljs-built_in">SetConsoleTextAttribute</span>(<span class="hljs-built_in">GetStdHandle</span>(STD_OUTPUT_HANDLE),FOREGROUND_INTENSITY|FOREGROUND_RED|FOREGROUND_GREEN|FOREGROUND_BLUE);<span class="hljs-comment">//恢复原来的颜色</span>
                <span class="hljs-built_in">closesocket</span>(server);
                <span class="hljs-built_in">closesocket</span>(client);
                <span class="hljs-built_in">WSACleanup</span>();
                <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(buffer_receive, <span class="hljs-string">"12582"</span>) == <span class="hljs-number">0</span>)<span class="hljs-comment">//如果聊天内容中含有12582，则本回合聊天结束，不然可以继续发送信息</span>
                <span class="hljs-keyword">break</span>;
            <span class="hljs-built_in">SetConsoleTextAttribute</span>(<span class="hljs-built_in">GetStdHandle</span>(STD_OUTPUT_HANDLE), FOREGROUND_INTENSITY | FOREGROUND_BLUE);<span class="hljs-comment">//设置蓝色</span>
            <span class="hljs-keyword">if</span> (tmp.<span class="hljs-built_in">find</span>(<span class="hljs-string">"0"</span>) != string::npos) {
                <span class="hljs-keyword">continue</span>;
            }
            cout &lt;&lt; tmp &lt;&lt; endl;
            cout &lt;&lt; <span class="hljs-string">"----------------------Detail--------------------"</span> &lt;&lt; endl &lt;&lt; <span class="hljs-string">"Message:"</span> &lt;&lt; tmp &lt;&lt; endl;
            cout &lt;&lt; <span class="hljs-string">"Ciphertext:"</span> &lt;&lt; buffer_receive &lt;&lt; endl;
            cout &lt;&lt; <span class="hljs-string">"----------------------Detail--------------------"</span> &lt;&lt; endl;
        }
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {<span class="hljs-comment">//发送消息</span>
            <span class="hljs-built_in">memset</span>(buffer, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(buffer));<span class="hljs-comment">//清空缓冲区</span>
            <span class="hljs-built_in">memset</span>(buffer_send, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(buffer_send));
            <span class="hljs-built_in">SetConsoleTextAttribute</span>(<span class="hljs-built_in">GetStdHandle</span>(STD_OUTPUT_HANDLE), FOREGROUND_INTENSITY | FOREGROUND_GREEN);<span class="hljs-comment">//设置绿色</span>
            string tmp_time = <span class="hljs-built_in">getTime</span>();
            cout &lt;&lt; tmp_time &lt;&lt; <span class="hljs-string">" "</span> &lt;&lt; server_name_tmp &lt;&lt; <span class="hljs-string">":"</span>;
            cin.<span class="hljs-built_in">getline</span>(buffer, BUF_SIZE);
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(buffer, <span class="hljs-string">"12582"</span>) == <span class="hljs-number">0</span>) {
                send_len = <span class="hljs-built_in">send</span>(client, buffer, <span class="hljs-built_in">sizeof</span>(buffer), <span class="hljs-number">0</span>);
                <span class="hljs-keyword">break</span>;
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(buffer, <span class="hljs-string">"12581"</span>) == <span class="hljs-number">0</span>) {
                send_len = <span class="hljs-built_in">send</span>(client, buffer, <span class="hljs-built_in">sizeof</span>(buffer), <span class="hljs-number">0</span>);
                <span class="hljs-built_in">SetConsoleTextAttribute</span>(<span class="hljs-built_in">GetStdHandle</span>(STD_OUTPUT_HANDLE), FOREGROUND_INTENSITY);
                cout &lt;&lt; <span class="hljs-string">"The program will exit in 3 seconds..."</span> &lt;&lt; endl;
                <span class="hljs-built_in">Sleep</span>(<span class="hljs-number">1000</span>);
                cout &lt;&lt; <span class="hljs-string">"The program will exit in 2 seconds..."</span> &lt;&lt; endl;
                <span class="hljs-built_in">Sleep</span>(<span class="hljs-number">1000</span>);
                cout &lt;&lt; <span class="hljs-string">"The program will exit in 1 seconds..."</span>;
                <span class="hljs-built_in">Sleep</span>(<span class="hljs-number">1000</span>);
                <span class="hljs-built_in">SetConsoleTextAttribute</span>(<span class="hljs-built_in">GetStdHandle</span>(STD_OUTPUT_HANDLE),FOREGROUND_INTENSITY|FOREGROUND_RED|FOREGROUND_GREEN|FOREGROUND_BLUE);<span class="hljs-comment">//恢复原来的颜色</span>
                <span class="hljs-built_in">closesocket</span>(server);
                <span class="hljs-built_in">closesocket</span>(client);
                <span class="hljs-built_in">WSACleanup</span>();
                <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
            }
            cout &lt;&lt; <span class="hljs-string">"----------------------Detail--------------------"</span> &lt;&lt; endl &lt;&lt; <span class="hljs-string">"Message:"</span> &lt;&lt; buffer &lt;&lt; endl;
            <span class="hljs-type">char</span>* tmp = <span class="hljs-built_in">encrypt</span>(buffer, key-&gt;k.<span class="hljs-built_in">data</span>(), key-&gt;e);
            cout &lt;&lt; <span class="hljs-string">"Ciphertext:"</span> &lt;&lt; tmp &lt;&lt; endl;
            cout &lt;&lt; <span class="hljs-string">"----------------------Detail--------------------"</span> &lt;&lt; endl;
            <span class="hljs-type">char</span> tmp1[<span class="hljs-number">10240</span>];
            <span class="hljs-built_in">strncpy</span>(tmp1, tmp, <span class="hljs-built_in">strlen</span>(tmp) + <span class="hljs-number">1</span>);
            send_len = <span class="hljs-built_in">send</span>(client, tmp1, <span class="hljs-built_in">sizeof</span>(tmp1), <span class="hljs-number">0</span>);
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h3 id="clienth"><a class="markdownIt-Anchor" href="#clienth"></a> Client.h</h3>
<pre class="highlight"><code class="C++"><span class="hljs-meta">#<span class="hljs-keyword">pragma</span> once</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdio&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;ctime&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstring&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstdlib&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;gmp.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"MD5.h"</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> KEY_LENGTH 2048  <span class="hljs-comment">//公钥的长度</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> BASE 16    <span class="hljs-comment">//输入输出的数字进制</span></span>
 
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;
 
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">key_pair</span>
{
    string n;
    string d;
    <span class="hljs-type">int</span> e;
    string k;
};

key_pair* key = <span class="hljs-keyword">new</span> key_pair;

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">keyInit</span><span class="hljs-params">()</span> </span>{
    key-&gt;n = <span class="hljs-string">"77232546f0b2983adb0ab839b04b81278bcbdc2d34f06a248333cd33e3c139fb578ca19b389e0253fa6f3b3b41e2fd0f6f1fa7e94499fa212afa7f0b2a89f8681dd00e3207c09586c7c6f923016455b652e93ae4bf3b905d7e955fb3102286d9947247f1e75921aaa35840ad3359091e701c167f28be312116c43a13946d0c8d5da8fa21938be40c1f60821d45ef8530d6e24adfd5ab2a1a6ad34545d83c5fcca02a7f29541d6d4cf29778593958957c9b4ad9693289db7743a05bf88480473dc028e4f8e32ff6bdd206910b971ae00c649038aa59baebe8b7af542e9a9b65f69e7efcc17d6a88244cc9520d4b009371c268058e62d707561825ad5a98a81d11"</span>;
    key-&gt;d = <span class="hljs-string">"369979d5082ca14d9fe34ac8cd7ddd0415b26906a2d367a1b22b8468ba816ca43edc6997ec9ba5af7cff8b22be305c0fbdbac1464bb55187efdd7b69cfa6099d15c4ab2ccc96bb3058d05c8f696ce54738ba40ce62c1d688b2a19c8940e4c1ee6774f479edafd099166134caebd46b3472e6bc7cac5c75c1976078c94e65a7b164a983dc15d98ed7d95041fa52adb643f87d7590bc1f476264caad4ea47adc7ec6aaedb5afe341a68afc6b8ee32a8eacf17b0d372afcf14258e87901395349a797443e50ee8bddf2fbf121799ba40a3e3b22e76341f07606dc7a810fb000dcbed3fc05a15223b04ff5f9610e9febae25a27a2871a2b75eacaba745e63bbc295d"</span>;
    key-&gt;e = <span class="hljs-number">65537</span>;
    key-&gt;k = <span class="hljs-string">"42ed95a8c26d10e856d7ac17e9451037457d5f6e66b824471229ac1422d28f868d6699492c7c31b6d10ed32ee6ad3cbb00bbefe2e76de75b924342781f3f67fd09a3d67c639363c97af569fb52863901f1b6b5e7901c00c989dd7847fc7f55989bf4775969254c2dc0d8e9f7e7dbb5e158c97f5d7d18de47766ee1efb2a3d7e899d019240701e2dec5ca8473a34cea6b6dcb62cff25d40858df7b37e3c14bac390d26926cf30c977b7417130bced9fcce5b7ff6923ab21652a2bf73c3dd0c40a3398f02261e9bd75a24134264412b3371c03daa715e2ad74c20d0ab895ab7025b0bec1eea316146127a5a6d97aa4f09c82624d7f897ef93a7d114cc0757d4253"</span>;
}

<span class="hljs-comment">//加密函数</span>
<span class="hljs-function"><span class="hljs-type">char</span> * <span class="hljs-title">encrypt</span><span class="hljs-params">(<span class="hljs-type">char</span> * plain_text, <span class="hljs-type">const</span> <span class="hljs-type">char</span> * key_n, <span class="hljs-type">int</span> key_e)</span>  
</span>{
    <span class="hljs-type">mpz_t</span> M, C1, n;
    <span class="hljs-built_in">mpz_init_set_str</span>(M, plain_text, BASE); 
    <span class="hljs-built_in">mpz_init_set_str</span>(n, key_n, BASE);
    <span class="hljs-built_in">mpz_init_set_ui</span>(C1, <span class="hljs-number">0</span>);
 
    <span class="hljs-built_in">mpz_powm_ui</span>(C1, M, key_e, n);    <span class="hljs-comment">//使用GMP中模幂计算函数</span>
 
    <span class="hljs-type">char</span> * result = <span class="hljs-keyword">new</span> <span class="hljs-type">char</span>[KEY_LENGTH + <span class="hljs-number">10</span>];
    <span class="hljs-built_in">mpz_get_str</span>(result, BASE, C1);
 
    <span class="hljs-keyword">return</span> result;
}
 
<span class="hljs-comment">//解密函数</span>
<span class="hljs-function"><span class="hljs-type">char</span> * <span class="hljs-title">decrypt</span><span class="hljs-params">(<span class="hljs-type">char</span> * cipher_text, <span class="hljs-type">const</span> <span class="hljs-type">char</span> * key_n, <span class="hljs-type">const</span> <span class="hljs-type">char</span> * key_d)</span>  
</span>{
    <span class="hljs-type">mpz_t</span> M, C1, n, d;
    <span class="hljs-built_in">mpz_init_set_str</span>(C1, cipher_text, BASE); 
    <span class="hljs-built_in">mpz_init_set_str</span>(n, key_n, BASE);
    <span class="hljs-built_in">mpz_init_set_str</span>(d, key_d, BASE);
    <span class="hljs-built_in">mpz_init</span>(M);
 
    <span class="hljs-built_in">mpz_powm</span>(M, C1, d, n);   <span class="hljs-comment">//使用GMP中的模幂计算函数</span>
 
    <span class="hljs-type">char</span> * result = <span class="hljs-keyword">new</span> <span class="hljs-type">char</span>[KEY_LENGTH + <span class="hljs-number">10</span>];
    <span class="hljs-built_in">mpz_get_str</span>(result, BASE, M);
 
    <span class="hljs-keyword">return</span> result;
}

<span class="hljs-function">string <span class="hljs-title">getTime</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-type">time_t</span> timep;
    <span class="hljs-built_in">time</span>(&amp;timep);
    <span class="hljs-type">char</span> tmp[<span class="hljs-number">64</span>];
    <span class="hljs-built_in">strftime</span>(tmp, <span class="hljs-built_in">sizeof</span>(tmp), <span class="hljs-string">"%Y-%m-%d %H:%M:%S"</span>, <span class="hljs-built_in">localtime</span>(&amp;timep));
    <span class="hljs-keyword">return</span> tmp;
}

<span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">IdConfirm</span> <span class="hljs-params">(string ID, string name)</span> </span>{
    MD5 tmp;
    string hash = tmp.<span class="hljs-built_in">encode</span>(name);
    <span class="hljs-keyword">if</span> (ID.<span class="hljs-built_in">compare</span>(hash)) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<h3 id="clientcpp"><a class="markdownIt-Anchor" href="#clientcpp"></a> Client.cpp</h3>
<pre class="highlight"><code class="C++"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;winsock.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;time.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">"windows.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"client.h"</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">pragma</span> comment(lib,<span class="hljs-string">"ws2_32.lib"</span>)<span class="hljs-comment">//加载ws2_32.dll</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> BUF_SIZE 4096   <span class="hljs-comment">//指定聊天信息缓冲区大小</span></span>

<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    WSADATA wsaData;
    <span class="hljs-built_in">WSAStartup</span>(<span class="hljs-built_in">MAKEWORD</span>(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>), &amp;wsaData);

    SOCKET client = <span class="hljs-built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);

    sockaddr_in server_addr;
    <span class="hljs-built_in">memset</span>(&amp;server_addr, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(server_addr));
    server_addr.sin_family = AF_INET;
    server_addr.sin_addr.S_un.S_addr = <span class="hljs-built_in">inet_addr</span>(<span class="hljs-string">"127.0.0.1"</span>);
    server_addr.sin_port = <span class="hljs-built_in">htons</span>(<span class="hljs-number">1234</span>);

    <span class="hljs-type">char</span> client_name[<span class="hljs-number">2048</span>] = { <span class="hljs-number">0</span> };
    <span class="hljs-type">char</span> client_name_tmp[<span class="hljs-number">2048</span>] = { <span class="hljs-number">0</span> };
    cout &lt;&lt; <span class="hljs-built_in">getTime</span>() &lt;&lt; <span class="hljs-string">" "</span> &lt;&lt; <span class="hljs-string">"Please enter your nickname:"</span>;
    cin.<span class="hljs-built_in">getline</span>(client_name_tmp, <span class="hljs-number">2048</span>);
    <span class="hljs-built_in">connect</span>(client, (SOCKADDR*)&amp;server_addr, <span class="hljs-built_in">sizeof</span>(server_addr));
    cout &lt;&lt; <span class="hljs-built_in">getTime</span>() &lt;&lt; <span class="hljs-string">" "</span> &lt;&lt; <span class="hljs-string">"Connection ready.\n"</span>;


    <span class="hljs-type">char</span> server_name[<span class="hljs-number">2048</span>] = { <span class="hljs-number">0</span> };
    <span class="hljs-type">char</span> buffer[BUF_SIZE] = { <span class="hljs-number">0</span> };
    <span class="hljs-type">char</span> buffer_send[BUF_SIZE + <span class="hljs-number">100</span>] = { <span class="hljs-number">0</span> };
    <span class="hljs-type">char</span> buffer_receive[BUF_SIZE + <span class="hljs-number">100</span>] = { <span class="hljs-number">0</span> };
    <span class="hljs-type">int</span> receive_len = <span class="hljs-number">0</span>;
    <span class="hljs-type">int</span> send_len = <span class="hljs-number">0</span>;

    MD5 tmp_name;
    string tmp_s = tmp_name.<span class="hljs-built_in">encode</span>(client_name_tmp);
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; tmp_s.<span class="hljs-built_in">length</span>(); i++) {
        client_name[i] = tmp_s[i];
    }

    send_len = <span class="hljs-built_in">send</span>(client, client_name, <span class="hljs-built_in">sizeof</span>(client_name), <span class="hljs-number">0</span>);
    receive_len = <span class="hljs-built_in">recv</span>(client, server_name, <span class="hljs-built_in">sizeof</span>(server_name), <span class="hljs-number">0</span>);

    <span class="hljs-built_in">SetConsoleTextAttribute</span>(<span class="hljs-built_in">GetStdHandle</span>(STD_OUTPUT_HANDLE), FOREGROUND_INTENSITY|FOREGROUND_RED);
    cout &lt;&lt; endl;
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">IdConfirm</span>(server_name, <span class="hljs-string">"lkp1"</span>)) {
        cout &lt;&lt; <span class="hljs-string">"ID Confirm success, Let's chatting..."</span> &lt;&lt; endl &lt;&lt; endl;
    } <span class="hljs-keyword">else</span> {
        cout &lt;&lt; <span class="hljs-string">"ID Confirm failed, Conversation aborted..."</span>;
        <span class="hljs-built_in">SetConsoleTextAttribute</span>(<span class="hljs-built_in">GetStdHandle</span>(STD_OUTPUT_HANDLE),FOREGROUND_INTENSITY|FOREGROUND_RED|FOREGROUND_GREEN|FOREGROUND_BLUE);
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }

    <span class="hljs-built_in">keyInit</span>();

    <span class="hljs-built_in">SetConsoleTextAttribute</span>(<span class="hljs-built_in">GetStdHandle</span>(STD_OUTPUT_HANDLE),FOREGROUND_INTENSITY|FOREGROUND_RED|FOREGROUND_GREEN|FOREGROUND_BLUE);
    cout &lt;&lt; <span class="hljs-string">"Please enter the message(just number) you want to send, or enter \"12582\" to abort this conversation, or enter \"12581\" to abort this chat"</span> &lt;&lt; endl;

    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            <span class="hljs-built_in">memset</span>(buffer, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(buffer));
            <span class="hljs-built_in">memset</span>(buffer_send, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(buffer_send));
            <span class="hljs-built_in">SetConsoleTextAttribute</span>(<span class="hljs-built_in">GetStdHandle</span>(STD_OUTPUT_HANDLE), FOREGROUND_INTENSITY | FOREGROUND_GREEN);<span class="hljs-comment">//设置绿色</span>
            string tmp_time = <span class="hljs-built_in">getTime</span>();
            cout &lt;&lt; tmp_time &lt;&lt; <span class="hljs-string">" "</span> &lt;&lt; client_name_tmp &lt;&lt; <span class="hljs-string">":"</span>;
            cin.<span class="hljs-built_in">getline</span>(buffer, <span class="hljs-built_in">sizeof</span>(buffer));
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(buffer, <span class="hljs-string">"12581"</span>) == <span class="hljs-number">0</span>) {
                send_len = <span class="hljs-built_in">send</span>(client, buffer, <span class="hljs-built_in">sizeof</span>(buffer), <span class="hljs-number">0</span>);
                <span class="hljs-built_in">SetConsoleTextAttribute</span>(<span class="hljs-built_in">GetStdHandle</span>(STD_OUTPUT_HANDLE), FOREGROUND_INTENSITY);
                cout &lt;&lt; <span class="hljs-string">"The program will exit in 3 seconds..."</span> &lt;&lt; endl;
                <span class="hljs-built_in">Sleep</span>(<span class="hljs-number">1000</span>);
                cout &lt;&lt; <span class="hljs-string">"The program will exit in 2 seconds..."</span> &lt;&lt; endl;
                <span class="hljs-built_in">Sleep</span>(<span class="hljs-number">1000</span>);
                cout &lt;&lt; <span class="hljs-string">"The program will exit in 1 seconds..."</span>;
                <span class="hljs-built_in">Sleep</span>(<span class="hljs-number">1000</span>);
                <span class="hljs-built_in">SetConsoleTextAttribute</span>(<span class="hljs-built_in">GetStdHandle</span>(STD_OUTPUT_HANDLE),FOREGROUND_INTENSITY|FOREGROUND_RED|FOREGROUND_GREEN|FOREGROUND_BLUE);<span class="hljs-comment">//恢复原来的颜色</span>
                <span class="hljs-built_in">closesocket</span>(client);
                <span class="hljs-built_in">WSACleanup</span>();
                <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(buffer, <span class="hljs-string">"12582"</span>) == <span class="hljs-number">0</span>) {
                send_len = <span class="hljs-built_in">send</span>(client, buffer, <span class="hljs-built_in">sizeof</span>(buffer), <span class="hljs-number">0</span>);
                <span class="hljs-keyword">break</span>;
            }
            cout &lt;&lt; <span class="hljs-string">"----------------------Detail--------------------"</span> &lt;&lt; endl &lt;&lt; <span class="hljs-string">"Message:"</span> &lt;&lt; buffer &lt;&lt; endl;
            <span class="hljs-type">char</span> * tmp = <span class="hljs-built_in">encrypt</span>(buffer, key-&gt;k.<span class="hljs-built_in">data</span>(), key-&gt;e);
            cout &lt;&lt; <span class="hljs-string">"Ciphertext:"</span> &lt;&lt; tmp &lt;&lt; endl;
            cout &lt;&lt; <span class="hljs-string">"----------------------Detail--------------------"</span> &lt;&lt; endl;
            <span class="hljs-type">char</span> tmp1[<span class="hljs-number">10240</span>];
            <span class="hljs-built_in">strncpy</span>(tmp1, tmp, <span class="hljs-built_in">strlen</span>(tmp) + <span class="hljs-number">1</span>);
            send_len = <span class="hljs-built_in">send</span>(client, tmp1, <span class="hljs-built_in">sizeof</span>(tmp1), <span class="hljs-number">0</span>);
        }
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            <span class="hljs-built_in">memset</span>(buffer_receive, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(buffer_receive));
            receive_len = <span class="hljs-built_in">recv</span>(client, buffer_receive, <span class="hljs-built_in">sizeof</span>(buffer_receive), <span class="hljs-number">0</span>);
            string tmp = <span class="hljs-built_in">decrypt</span>(buffer_receive, key-&gt;n.<span class="hljs-built_in">data</span>(), key-&gt;d.<span class="hljs-built_in">data</span>());
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(buffer_receive, <span class="hljs-string">"12581"</span>) == <span class="hljs-number">0</span>) {
                <span class="hljs-built_in">SetConsoleTextAttribute</span>(<span class="hljs-built_in">GetStdHandle</span>(STD_OUTPUT_HANDLE), FOREGROUND_INTENSITY);
                cout &lt;&lt; <span class="hljs-string">"The program will exit in 3 seconds..."</span> &lt;&lt; endl;
                <span class="hljs-built_in">Sleep</span>(<span class="hljs-number">1000</span>);
                cout &lt;&lt; <span class="hljs-string">"The program will exit in 2 seconds..."</span> &lt;&lt; endl;
                <span class="hljs-built_in">Sleep</span>(<span class="hljs-number">1000</span>);
                cout &lt;&lt; <span class="hljs-string">"The program will exit in 1 seconds..."</span>;
                <span class="hljs-built_in">Sleep</span>(<span class="hljs-number">1000</span>);
                <span class="hljs-built_in">SetConsoleTextAttribute</span>(<span class="hljs-built_in">GetStdHandle</span>(STD_OUTPUT_HANDLE),FOREGROUND_INTENSITY|FOREGROUND_RED|FOREGROUND_GREEN|FOREGROUND_BLUE);<span class="hljs-comment">//恢复原来的颜色</span>
                <span class="hljs-built_in">closesocket</span>(client);
                <span class="hljs-built_in">WSACleanup</span>();
                <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(buffer_receive, <span class="hljs-string">"12582"</span>) == <span class="hljs-number">0</span>)
                <span class="hljs-keyword">break</span>;
            <span class="hljs-built_in">SetConsoleTextAttribute</span>(<span class="hljs-built_in">GetStdHandle</span>(STD_OUTPUT_HANDLE), FOREGROUND_INTENSITY | FOREGROUND_BLUE);<span class="hljs-comment">//设置蓝色</span>
            <span class="hljs-keyword">if</span> (tmp.<span class="hljs-built_in">find</span>(<span class="hljs-string">"0"</span>) != string::npos) {
                <span class="hljs-keyword">continue</span>;
            }
            cout &lt;&lt; tmp &lt;&lt; endl;
            cout &lt;&lt; <span class="hljs-string">"----------------------Detail--------------------"</span> &lt;&lt; endl &lt;&lt; <span class="hljs-string">"Message:"</span> &lt;&lt; tmp &lt;&lt; endl;
            cout &lt;&lt; <span class="hljs-string">"Ciphertext:"</span> &lt;&lt; buffer_receive &lt;&lt; endl;
            cout &lt;&lt; <span class="hljs-string">"----------------------Detail--------------------"</span> &lt;&lt; endl;
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>

    </div>

    <div class="totop">ToTop</div>
    <script type="text/javascript" src="../libs/codeBlock/codeBlockFuction.js"></script>
    <!-- 代码语言 -->
    <script type="text/javascript" src="../libs/codeBlock/codeLang.js"></script>
    <!-- 代码块复制 -->
    <script type="text/javascript" src="../libs/codeBlock/codeCopy.js"></script>
    <script type="text/javascript" src="../libs/codeBlock/clipboard.min.js"></script>
    <!-- 代码块收缩 -->
    <script type="text/javascript" src="../libs/codeBlock/codeShrink.js"></script> 
    <!-- 代码块折行 -->
    <style type="text/css">code[class*="language-"], pre[class*="language-"] { white-space: pre !important; }</style>
</div>
        <div class="footer">
    <a href="#">
        2020 <i class="fab fa-studiovinari"></i> Nefelibata <i class="fas fa-angle-double-up"></i>
    </a>
</div>


<script src="/blog/js/totop.js"></script>


<script src="/blog/js/search.js"></script>

    </div>
</body>

</html>